# This is a basic workflow to help you get started with Actions

name: Cleaning-CI/CD

on:
  push:
    branches:
      - main
    paths:
      - cleaning/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest

    env:
        SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
        SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
        SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
        SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
        SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
        SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Use Python 3.8.x
        uses: actions/setup-python@v2.2.1
        with:
          python-version: 3.8.x
      
          
      - name: Install SnowSQL
        run: |
          curl -O https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.2/linux_x86_64/snowsql-1.2.9-linux_x86_64.bash
          SNOWSQL_DEST=~/bin SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql-1.2.9-linux_x86_64.bash
          echo "$HOME/bin" >> $GITHUB_PATH

      # Deploy the SQL script with SnowSQL
      - name: Deploy the SQL script with SnowSQL
        run: |
          # Run SnowSQL for each SQL file in the cleaning/ directory
          for file in cleaning/*.sql; do
            ~/bin/snowsql -a $SNOWSQL_ACCOUNT -d $SNOWSQL_DATABASE -u $SNOWSQL_USERNAME -r $SNOWSQL_ROLE -w $SNOWSQL_WAREHOUSE -o exit_on_error=true -f $file
          done
